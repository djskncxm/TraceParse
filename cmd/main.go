package main

import (
	"flag"
	"fmt"
	"github.com/djskncxm/TraceParse/pkg/core"
	"github.com/djskncxm/TraceParse/pkg/tui"
	"github.com/gdamore/tcell/v2"
	"github.com/rivo/tview"
)

func main() {
	// 添加命令行参数解析
	var traceFile string
	flag.StringVar(&traceFile, "f", "", "Trace file to load")
	flag.StringVar(&traceFile, "file", "", "Trace file to load")
	flag.Parse()

	app := tview.NewApplication()

	// 创建 TraceManager 和 User
	tm := core.NewTraceManager()
	user := core.NewUser(tm)

	// 创建视图
	asmView := tui.NewAsmView()
	regView := tui.NewRegView()
	statusView := tui.NewStatusView()
	memoryView := tui.NewMemoryView()

	// 创建应用状态
	state := &tui.AppState{
		TraceManager: tm,
		User:         user,
		App:          app,
		AsmView:      asmView,
		RegView:      regView,
		StatusView:   statusView,
		MemoryView:   memoryView,
		AutoStepChan: make(chan bool, 1),
	}

	// 启动自动步进管理器
	go tui.StartAutoStep(state)

	// 创建输入框
	inputField := tui.NewInputView(state)
	state.InputField = inputField

	// 添加全局键盘快捷键
	app.SetInputCapture(func(event *tcell.EventKey) *tcell.EventKey {
		switch event.Key() {
		case tcell.KeyRight:
			// 右箭头：下一个指令
			cmd := user.ParseCommand("n")
			tui.UpdateDisplay(state, cmd)
			return nil
		case tcell.KeyLeft:
			// 左箭头：上一个指令
			cmd := user.ParseCommand("p")
			tui.UpdateDisplay(state, cmd)
			return nil
		case tcell.KeyRune:
			switch event.Rune() {
			case 'q', 'Q':
				app.Stop()
				return nil
			case ']':
				// 空格键：重复上一个命令或执行next
				cmd := user.ParseCommand("")
				if cmd != nil {
					tui.UpdateDisplay(state, cmd)
				} else {
					// 否则执行next
					// cmd = user.ParseCommand("n")
					// tui.UpdateDisplay(state, cmd)
					return nil
				}
				return nil
			}
		}
		return event
	})

	// 创建右侧面板
	rightPanel := tview.NewFlex().
		SetDirection(tview.FlexRow).
		AddItem(statusView, 5, 1, false).
		AddItem(regView, 0, 3, false).
		AddItem(inputField, 3, 0, true)

	// 创建根布局
	root := tview.NewFlex().
		AddItem(asmView, 0, 1, false).    // 汇编视图占2/5
		AddItem(rightPanel, 0, 2, false). // 右侧面板占2/5
		AddItem(memoryView, 0, 1, false)  // 内存视图占1/5

	// 加载指令文件
	go func() {
		var filename string

		// 优先使用命令行参数指定的文件
		if traceFile != "" {
			filename = traceFile
		}

		if filename != "" {
			err := tui.LoadInstructionsFromFile(filename, state)
			if err != nil {
				// 如果没有文件，创建一些示例指令
				statusView.SetText("Error loading file: " + err.Error() +
					"\nUsing example instructions...")

				// 添加一些示例指令
				exampleInstructions := []string{
					"0001|0x400000|0x0|\"add x0, x1, x2\"|0x0|0x1|0x2|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x400000|0x400004",
					"0002|0x400004|0x4|\"sub x3, x4, x5\"|0x0|0x1|0x2|0x0|0x4|0x5|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x400004|0x400008",
					"0003|0x400008|0x8|\"ldr x6, [x7, #16]\"|0x0|0x1|0x2|0x0|0x4|0x5|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x400008|0x40000c",
					"0004|0x40000c|0xc|\"add x1, x2, x3\"|0x0|0x3|0x2|0x3|0x4|0x5|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x40000c|0x400010",
					"0005|0x400010|0x10|\"mov x8, x9\"|0x0|0x3|0x2|0x3|0x4|0x5|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x400010|0x400014",
				}

				for _, line := range exampleInstructions {
					if traceLine, err := core.ParseLine(line); err == nil {
						tm.AddInstruction(traceLine)
					}
				}

				tui.UpdateDisplay(state, nil)
			}
		} else {
			// 如果没有指定文件，使用示例
			statusView.SetText("No file specified. Using example instructions...")
			
			// 添加一些示例指令
			exampleInstructions := []string{
				"0001|0x400000|0x0|\"add x0, x1, x2\"|0x0|0x1|0x2|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x400000|0x400004",
				"0002|0x400004|0x4|\"sub x3, x4, x5\"|0x0|0x1|0x2|0x0|0x4|0x5|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x400004|0x400008",
				"0003|0x400008|0x8|\"ldr x6, [x7, #16]\"|0x0|0x1|0x2|0x0|0x4|0x5|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x400008|0x40000c",
				"0004|0x40000c|0xc|\"add x1, x2, x3\"|0x0|0x3|0x2|0x3|0x4|0x5|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x40000c|0x400010",
				"0005|0x400010|0x10|\"mov x8, x9\"|0x0|0x3|0x2|0x3|0x4|0x5|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x0|0x400010|0x400014",
			}

			for _, line := range exampleInstructions {
				if traceLine, err := core.ParseLine(line); err == nil {
					tm.AddInstruction(traceLine)
				}
			}

			tui.UpdateDisplay(state, nil)
		}
	}()

	// 设置初始帮助信息
	helpText := `Welcome to TraceParse!
  
  Commands:
    n, next       - Next instruction (n5 for 5 steps)
    p, prev       - Previous instruction (p3 for 3 steps)
    g <line>      - Go to specific line
    r, reg        - Show registers
    run           - Auto step through instructions
    stop          - Stop auto stepping
    step <ms>     - Set step delay in milliseconds
    space         - Repeat last command or step forward
    ←/→           - Previous/Next instruction
    q, quit       - Quit
  
  Tip: Press Enter without typing to repeat last command!`

	statusView.SetText(helpText)

	// 运行应用
	if err := app.SetRoot(root, true).
		SetFocus(inputField).
		Run(); err != nil {
		fmt.Printf("Error running application: %v\n", err)
	}
}
